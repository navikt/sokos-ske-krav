name: Dev-first check
on:
  pull_request:
    branches: [ main ]   # runs on PRs targeting main

jobs:
  check:
    name: must-merge-into-dev-first
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const headRef = pr.head.ref;                 // feature branch name
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Find a merged PR from this branch into 'dev'
            const { data: prs } = await github.rest.pulls.list({
              owner, repo,
              state: 'closed',
              base: 'dev',
              head: `${owner}:${headRef}`,
              per_page: 100
            });

            const merged = prs.find(p => p.merged_at);
            if (!merged) {
              core.setFailed(`Blocked: '${headRef}' must be merged into 'dev' before it can merge to 'main'.`);
            } else {
              core.info(`OK: Found merged PR #${merged.number} into 'dev' on ${merged.merged_at}.`);
            }
